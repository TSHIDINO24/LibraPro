<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Boxicons -->
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <!-- My CSS -->
    <link rel="stylesheet" href="css/dashboardstyle.css">
    <title>LibraPro Library - View Books</title>
    <style>


        #myTable {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 20px;

        }

        #myTable th,
        #myTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        #myTable th {
            background-color: #f2f2f2;
        }

        #myTable img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
        }

        #myTable button {
            padding: 5px 10px;
        }


        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            /* Adjust as needed */
            justify-content: center;
            align-items: center;
        }

        .popupForm {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 20px;
            text-align: center;
            position: relative;
            width: 300px;
        }

        .closePopup {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 14px;
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
        }

        .closePopup:hover {
            color: #555;
        }

        .form-input {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn-submit {
            background-color: #fc8010;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-submit:hover {
            background-color: #333;
        }
    </style>
</head>

<body>
   <!-- SIDEBAR -->
 <section id="sidebar">
	<a href="#" class="brand">
		<i class='bx bxs-book'></i>
		<span class="text">LibraPro</span>
	</a>
	<ul class="side-menu top">
		<li>
			<a href="index.html" class="nav-link.manage-users">
				<i class='bx bxs-dashboard'></i>
				<span class="text">Dashboard</span>
			</a>
		</li>
		<li>
			<a href="ManageUsers.html" class="nav-link.manage-users">
				<i class='bx bxs-user'></i>
				<span class="text">Manage Users</span>
			</a>
		</li>
		<li>
			<a href="ManageBooks.html" class="nav-link">
				<i class='bx bxs-book'></i>
				<span class="text">Manage Books</span>
			</a>
		</li>
		<!--li>
				<a href="ManageDamagedBooks.html" class="nav-link">
					<i class='bx bxs-book'></i>
					<span class="text">Manage Damaged Books</span>
				</a>
			</li-->
		<!--li>
			<a href="FineManagement.html" class="nav-link">
				<i class='bx bxs-book'></i>
				<span class="text">Manage Fines</span>
			</a>
		</li>
		<li>
			<a href="NotificationPage.html" class="nav-link">
				<i class='bx bxs-message-dots' ></i>
				<span class="text">Notifications</span>
			</a>
		</li-->
		<li>
			<a href="PendingOrders.html" class="nav-link">
				<i class='bx bxs-message-dots' ></i>
				<span class="text">Pending Orders</span>
			</a>
		</li>
		<li>
			<a href="CheckedOutBooksPage.html" class="nav-link">
				<i class='bx bxs-shopping-bag-alt'></i>
				<span class="text">Checked Out Books</span>
			</a>
		</li>
		<li>
			<a href="\LibraProWeb\index.html" class="nav-link">
				<i class='bx bxs-user'></i>
				<span class="text">Logout</span>
			</a>
		</li>
	 </ul>
	</div>
	</section>
<!-- SIDEBAR -->

 <!--CONTENT-->
 <section id="content">

    <!-- NAVBAR -->
    <nav>

        <a href="#" class="nav-link"></a>
        <form action="#">

        </form>
        <input type="checkbox" id="switch-mode" hidden>
        <a href="#" class="notification">
            <i class='bx bxs-bell'></i>
            <span id="notificationCount" class="num">0</span>
        </a>
        <ul id="notificationList"></ul>

        <div class="dropdown">
            <a href="#" class="profile">
                <img src="img/user.png">
            </a>
            <div class="dropdown-content">
                <a href="\LibraProWeb\index.html">LogOut</a>
                <a href="#">Settings</a>
            </div>
        </div>
    </nav>
    <!-- NAVBAR -->

    <!-- MAIN -->
    <main>
        <div class="head-title">
            <div class="left">
                <h1>Manage Books</h1>
            </div>
        </div>
        <div class="head">
            <h3>Available Books</h3>
            <div class="form-input">
                <input type="search" placeholder="Filter..." id="myInput" onkeyup="myFunction()">
            </div>
        </div>
            <div class="table-data">
                <div class="order">
                    <div class="head">
                        <!--h3>Recent Borrows</h3>
                    <div class="form-input">
                        <input type="search" placeholder="Search..." id="myInput" onkeyup="myFunction()">
                    </div>
                    <i class='bx bx-filter' ></i>
                    <button id="openCameraButton">Open Camera</button>
                    <div id="cameraModal" class="modal">
                      <div class="modal-content">
                        <video id="preview" style="width: 100%; height: 100%;"></video>
                      </div>
                    </div-->
                    </div>
                    <table id="myTable">
                        <thead>
                            <tr>
                                <th>ISBN</th>
                                <th>Image</th>
                                <th>Title</th>
                                <th>Quantity</th>
                                <th>Action</th>
                               
                            </tr>
                        </thead>
                        <tbody id="data_table">
                            <td>
                                <button id="showPopup">Edit</button>
                            </td>
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="successPopup" class="popup-overlay" style="display: none;">
                <div class="popupForm">
                    <button class="closePopup" id="closeSuccessPopup">x</button>
                    <p id="successMessage"></p>
                </div>
            </div>

            <button class="closePopup" id="closePopupAdd">close page</button>

    </main>


    <div class="popup-overlay" id="popupOverlay" style="display: none;">
        <div class="popupForm">
            <button class="closePopup" id="closePopup">x</button>
            <h2>Edit Existing Book</h2>
            <form>
                <div class="form-input">
                    <label for="editTitle">Title:</label>
                    <input type="text" id="editTitle" required>
                </div>
                <div class="form-input">
                    <label for="editAuthor">Author:</label>
                    <input type="text" id="editAuthor" required>
                </div>
                <div class="form-input">
                    <label for="editDescription">Description:</label>
                    <input type="text" id="editDescription" required>
                </div>
                <div class="form-input">
                    <label for="editQuantity">Quantity:</label>
                    <input type="number" id="editQuantity" required>
                </div>
                <!--<div class="form-input">
                    <label for="editImage">Image URL:</label>
                    <input type="text" id="editImage" required>
                </div> -->
                <div class="form-input">
                    <label for="editIsbn">ISBN:</label>
                    <input type="text" id="editIsbn" required>
                </div>
                <div class="form-input">
                    <label for="category">Category:</label>
                    <select id="editcategory" required>
                    </select>
                <div>
                <div>
                    <button type="submit" class="btn-submit" id="editBookBtn">Edit Book</button>
                </div>
            </form>
        </div>
    </div>
</section>


<script>
    // Event listener for the "Close Page" button
    document.getElementById('closePopupAdd').addEventListener('click', function () {
    // Close the current window or tab
    window.close();
});

    // Function to show a success pop-up message
    function showSuccessPopup(message) {
    const successPopup = document.getElementById('successPopup');
    const successMessage = document.getElementById('successMessage');
    successMessage.textContent = message;
    successPopup.style.display = 'flex';

    // Close the success pop-up when the close button is clicked
    document.getElementById('closeSuccessPopup').addEventListener('click', function () {
        successPopup.style.display = 'none';
    });
}

//Filtering the table by the Book isbn
function myFunction() {
			// Declare variables
			var input, filter, table, tr, td, i, txtValue;
			input = document.getElementById("myInput");
			filter = input.value.toUpperCase();
			table = document.getElementById("myTable");
			tr = table.getElementsByTagName("tr");

			// Loop through all table rows, and hide those who don't match the search query
			for (i = 0; i < tr.length; i++) {
				td = tr[i].getElementsByTagName("td")[0];
				if (td) {
					txtValue = td.textContent || td.innerText;
					if (txtValue.toUpperCase().indexOf(filter) > -1) {
						tr[i].style.display = "";
					} else {
						tr[i].style.display = "none";
					}
				}
			}
		}

        document.addEventListener("DOMContentLoaded", function () {
            const openButton = document.getElementById("openForm");
            const modal = document.getElementById("registrationForm");
            const closeButton = document.getElementById('.close');

            openButton.addEventListener("click", function () {
                modal.style.display = "block";
            });

            closeButton.addEventListener("click", function () {
                modal.style.display = "none";
            });

            window.addEventListener("click", function (event) {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            });
        });
         //Pop up 
        const showPopupButton = document.getElementById('showPopup');
        const closePopupButton = document.getElementById('closePopup');
        const popupOverlay = document.getElementById('popupOverlay');

        showPopupButton.addEventListener('click', () => {
            console.log('Edit button clicked');
            popupOverlay.style.display = 'flex';
        });

        closePopupButton.addEventListener('click', () => {
            console.log('Close button clicked');
            popupOverlay.style.display = "none";
        });

        popupOverlay.addEventListener('click', (e) => {
            if (e.target === popupOverlay) {
                popupOverlay.style.display = 'none';
            }
        });

        popupOverlay.querySelector('.popupForm').addEventListener('click', (e) => {
            e.stopPropagation();
        });

        popupOverlay.querySelector('form').addEventListener('submit', (e) => {
            e.preventDefault();
            popupOverlay.style.display = 'none';
        });
             

          // Fetch categories data from the API
    fetch('https://localhost:44310/api/Category/getallcategories')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (Array.isArray(data)) {
                console.log('Fetched data:', data);
                // Populate the category select field
                populateCategorySelect(data);
            } else {
                throw new Error('Invalid JSON data received from the API');
            }
        })
        .catch(error => {
            console.error('Error fetching or parsing data:', error);
        });

// Function to populate the category select field
function populateCategorySelect(categories) {
    const categorySelect = document.getElementById('category');
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.categoryId;
        option.text = category.categoryName;
        categorySelect.appendChild(option);
    });
}

        let bookToEdit = null;
        //A function to populate the Books table
        function populateBooksTable(data) {
            var tableBody = document.getElementById('data_table');
            tableBody.innerHTML = ''; // Clear existing data

            data.forEach(function (book) {
                var row = document.createElement('tr');

                var idCell = document.createElement('td');
                idCell.textContent = book.isbn;
                row.appendChild(idCell);

                var imageCell = document.createElement('td');
                var image = document.createElement('img');
                image.src = book.bookImage;
                image.style.width = "120px";
                image.style.height = "120px";
                imageCell.appendChild(image);
                row.appendChild(imageCell);

                var titleCell = document.createElement('td');
                titleCell.textContent = book.bookTitle;
                row.appendChild(titleCell);

                var quantityCell = document.createElement('td');
                quantityCell.textContent = book.bookQuantity;
                row.appendChild(quantityCell);

                var actionCell = document.createElement('td');
                // Create an "Edit" button for each book row
                var editButton = document.createElement('button');
                editButton.className = 'edit-button orange-button';
                editButton.textContent = 'Edit';
                editButton.setAttribute('data-book-id', book.isbn); 
                actionCell.appendChild(editButton);
                row.appendChild(actionCell);

           
                tableBody.appendChild(row);
            });
            const editButtons = document.querySelectorAll('.edit-button');
            editButtons.forEach(function (editButton) {
            editButton.addEventListener('click', function () {
            // Handle the edit action here using the book ID from the data attribute
            const bookId = this.getAttribute('data-book-id');
            // Find the book with the matching bookId in the data
             bookToEdit = data.find(function (book) {
                return book.isbn === bookId;
            });

            if (bookToEdit) {
                // Populate the edit form fields with the book data
                document.getElementById('editTitle').value = bookToEdit.bookTitle;
                document.getElementById('editAuthor').value = bookToEdit.bookAuthor;
                document.getElementById('editDescription').value = bookToEdit.bookDescription;
                document.getElementById('editQuantity').value = bookToEdit.bookQuantity;
                //document.getElementById('editImage').value = bookToEdit.bookImage;
                document.getElementById('editIsbn').value = bookToEdit.isbn;
                parseInt(document.getElementById("editCategory").value),
                document.getElementById("editCategory").options[document.getElementById("category").selectedIndex].text
                // Show the popup
            popupOverlay.style.display = 'flex';
            } else {
                console.error('Book not found for editing');
            }
        });
    });
        }

      

        // an API request to populate the table
        fetch('https://localhost:44310/api/Book/allbooks')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Fetched data:', data);
                // Call the function that uses the fetched data
                populateBooksTable(data);
            })

            .catch(error => console.error('Error fetching data:', error));
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
       // Event listener for the "Edit Book" form submission
       document.querySelector('.popupForm form').addEventListener('submit', function (event) {
        event.preventDefault();

        // Get the edited book data from the form fields
        const editedBookData = {
            bookTitle: document.getElementById('editTitle').value,
            bookAuthor: document.getElementById('editAuthor').value,
            bookDescription: document.getElementById('editDescription').value,
            bookQuantity: parseInt(document.getElementById('editQuantity').value),
            //bookImage: document.getElementById('editImage').value,
            isbn: document.getElementById('editIsbn').value,
            categoryID: document.getElementById('editCategory').value
        };

        // Send a PUT request to update the book data
        fetch(`https://localhost:44310/api/Book/editbook`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(editedBookData),
        })
        .then(response => response.json())
        .then(updatedBook => {
            console.log('Book updated:', updatedBook);

            // Show a success pop-up message
            showSuccessPopup("Book updated successfully");

            // Fetch data again to refresh the table after editing
fetch('https://localhost:44310/api/Book/allbooks')
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(newData => {
        console.log('Fetched data after editing:', newData);
        // Call the function that uses the fetched data
        populateBooksTable(newData);
        modal.style.display = 'none'; // Close the edit form
    })
    .catch(error => console.error('Error fetching data after editing:', error));
            modal.style.display = 'none'; // Close the edit form
        })
        .catch(error => {
            console.error('Error updating book:', error);
        });
    });
    </script>
    <!--<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script> -->
</body>

</html>